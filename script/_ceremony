#!/usr/bin/env bash

set -eou pipefail

. oks-lib.sh

command_on_path lpinfo
command_on_path systemctl
command_on_path sed
command_on_path oks

# NixOS generates `printers.conf` for us but we can't know the printers SN in
# advance of the first ceremony where it's used. As a work-around we query cups
# for the serial number for the attached printer and then swap it in
# `printers.conf` with the place holder `SN_GOES_HERE`
PRINTER_SN_REGEX='^direct[[:space:]]\+usb:\/\/Brother\/QL-600?serial=\(.*\)$'
PRINTER_SN=$(lpinfo -v | sed -n "s/$PRINTER_SN_REGEX/\1/p")
info "Label printer with SN: $PRINTER_SN found"

systemctl stop cups.service
sed -i "s/SN_GOES_HERE/$PRINTER_SN/g" /etc/cups/printers.conf
systemctl start cups.service
info "Label printer with SN: $PRINTER_SN configured"

info "Generating keys from keyspecs ..."
oks hsm generate --auth-method cdr

info "Initializing CAs for keyspecs ..."
oks ca --auth-method cdr initialize

info "Signing requests intermediates & debug auth credentials"
oks ca --auth-method cdr sign
